<!DOCTYPE html>
<html>
<head>
  <title>BLE Step Tracker</title>
</head>
<body>
  <h1>Step 2 Tracker</h1>
  <button onclick="connect()">Connect</button>
  <p><strong>Steps:</strong> <span id="steps">-</span></p>
  <p><strong>Pace:</strong> <span id="pace">-</span></p>

  <script>
    const serviceUUID = '0000ffe0-0000-1000-8000-00805f9b34fb';
    const notifyUUID  = '0000ffe4-0000-1000-8000-00805f9b34fb';

    function parseData(data) {
      const text = new TextDecoder().decode(data);
      console.log('Notification received:', text);

      const match = text.match(/STEPS:(\d+),PACE:(\w+)/);
      if (match) {
        document.getElementById('steps').textContent = match[1];
        document.getElementById('pace').textContent = match[2];
      }
    }

    async function connect() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: ['0000ffe0-0000-1000-8000-00805f9b34fb']
        });
    
        // Explicit reconnect step
        const server = await device.gatt.connect();
    
        const service = await server.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb');
        const char = await service.getCharacteristic('0000ffe4-0000-1000-8000-00805f9b34fb');
    
        await char.startNotifications();
        char.addEventListener('characteristicvaluechanged', event => {
          parseData(event.target.value);
        });
    
        console.log('Subscribed to notifications.');
      } catch (err) {
        alert('Connection failed: ' + err);
        console.error(err);
      }
    }

  </script>
</body>
</html>
