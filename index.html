<!DOCTYPE html>
<html>
<head>
  <title>BLE Step Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; padding: 1em; }
    #log { white-space: pre-wrap; font-family: monospace; border: 1px solid #ccc; padding: 0.5em; height: 100px; overflow-y: scroll; }
  </style>
</head>
<body>
  <h1>Step 4 Tracker</h1>

  <button onclick="connect()">Connect to BLE</button>
  <button onclick="disconnect()">Disconnect</button>
  <p><strong>Status:</strong> <span id="status">Not connected</span></p>
  <p><strong>Subscription:</strong> <span id="subscription">Not subscribed</span></p>
  <p><strong>Raw BLE Data:</strong> <span id="raw">-</span></p>
  <p><strong>Steps:</strong> <span id="steps">-</span></p>
  <p><strong>Pace:</strong> <span id="pace">-</span></p>

  <div id="log"></div>

  <script>
    const serviceUUID = '0000ffe0-0000-1000-8000-00805f9b34fb';
    const notifyUUID  = '0000ffe4-0000-1000-8000-00805f9b34fb';

    let bleDevice = null;
    let reconnectInterval = null;

    function setStatus(text) {
      document.getElementById('status').textContent = text;
    }

    function setSubscriptionStatus(text) {
      document.getElementById('subscription').textContent = text;
    }

    function log(text) {
      const logDiv = document.getElementById('log');
      logDiv.textContent += text + '\n';
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function parseData(data) {
      const text = new TextDecoder().decode(data);
      console.log('Notification received:', text);
      document.getElementById('raw').textContent = text;
      log('Received: ' + text);

      const match = text.match(/STEPS:(\d+),PACE:(\w+)/);
      if (match) {
        document.getElementById('steps').textContent = match[1];
        document.getElementById('pace').textContent = match[2];
      }
    }

    async function subscribeToNotifications(server) {
      try {
        const service = await server.getPrimaryService(serviceUUID);
        const char = await service.getCharacteristic(notifyUUID);

        await char.startNotifications();
        char.addEventListener('characteristicvaluechanged', event => {
          parseData(event.target.value);
        });

        setStatus("Connected");
        setSubscriptionStatus("Subscribed to FFE4");
        log("Subscribed to notifications.");
        stopReconnect(); // Success â€” stop retry loop
      } catch (err) {
        setStatus("Subscription failed");
        setSubscriptionStatus("Not subscribed");
        log("Failed to subscribe: " + err);
        console.error(err);
        startReconnect();
      }
    }

    async function connect() {
      try {
        if (bleDevice) {
          if (bleDevice.gatt.connected) {
            log("Already connected.");
            setStatus("Already connected.");
            return;
          } else {
            setStatus("Reconnecting...");
            const server = await bleDevice.gatt.connect();
            await subscribeToNotifications(server);
            return;
          }
        }

        setStatus("Requesting device...");
        bleDevice = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: [serviceUUID]
        });

        bleDevice.addEventListener('gattserverdisconnected', () => {
          setStatus("Disconnected");
          setSubscriptionStatus("Not subscribed");
          log("Device disconnected.");
          bleDevice = null;
          startReconnect(); // retry when lost
        });

        setStatus("Connecting...");
        const server = await bleDevice.gatt.connect();
        await subscribeToNotifications(server);

      } catch (err) {
        setStatus("Connection failed");
        setSubscriptionStatus("Not subscribed");
        alert('Connection failed: ' + err);
        console.error(err);
        bleDevice = null;
        startReconnect();
      }
    }

    function disconnect() {
      if (bleDevice && bleDevice.gatt.connected) {
        bleDevice.gatt.disconnect();
        setStatus("Disconnected by user");
        setSubscriptionStatus("Not subscribed");
        log("Disconnected from device.");
      } else {
        alert("No device is currently connected.");
      }
      bleDevice = null;
      stopReconnect();
    }

    function startReconnect() {
      if (!reconnectInterval) {
        log("Starting reconnect attempts every 3 seconds...");
        reconnectInterval = setInterval(() => {
          if (!bleDevice) {
            log("Attempting to reconnect...");
            connect();
          }
        }, 3000);
      }
    }

    function stopReconnect() {
      if (reconnectInterval) {
        clearInterval(reconnectInterval);
        reconnectInterval = null;
        log("Stopped reconnect attempts.");
      }
    }
  </script>
</body>
</html>
