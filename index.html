<!DOCTYPE html>
<html>
<head>
  <title>BLE Step Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; padding: 1em; }
    #log { white-space: pre-wrap; font-family: monospace; border: 1px solid #ccc; padding: 0.5em; height: 100px; overflow-y: scroll; }
  </style>
</head>
<body>
  <h1>Step Tracker</h1>
  <button onclick="connect()">Connect to BLE</button>
  <button onclick="disconnect()">Disconnect</button>
  <p><strong>Status:</strong> <span id="status">Not connected</span></p>
  <p><strong>Subscription:</strong> <span id="subscription">Not subscribed</span></p>
  <p><strong>Raw BLE Data:</strong> <span id="raw">-</span></p>
  <p><strong>Steps:</strong> <span id="steps">-</span></p>
  <p><strong>Pace:</strong> <span id="pace">-</span></p>
  <div id="log"></div>

  <script>
    const serviceUUID = '0000ffe0-0000-1000-8000-00805f9b34fb'; // Verify this
    const notifyUUID = '0000ffe4-0000-1000-8000-00805f9b34fb'; // Verify this

    let bleDevice = null;
    let reconnectInterval = null;

    function setStatus(text) {
      document.getElementById('status').textContent = text;
    }

    function setSubscriptionStatus(text) {
      document.getElementById('subscription').textContent = text;
    }

    function log(text) {
      const logDiv = document.getElementById('log');
      logDiv.textContent += text + '\n';
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function parseData(data) {
      const text = new TextDecoder().decode(data);
      console.log('Notification received:', text);
      document.getElementById('raw').textContent = text;
      log('Received: ' + text);

      const match = text.match(/STEPS:(\d+),PACE:(\w+)/);
      if (match) {
        document.getElementById('steps').textContent = match[1];
        document.getElementById('pace').textContent = match[2];
      }
    }

    async function subscribeToNotifications(server) {
      try {
        const service = await server.getPrimaryService(serviceUUID);
        const char = await service.getCharacteristic(notifyUUID);
        log(`Characteristic properties: ${JSON.stringify(char.properties)}`);
        await char.startNotifications();
        char.addEventListener('characteristicvaluechanged', event => {
          parseData(event.target.value);
        });
        setStatus("Connected");
        setSubscriptionStatus("Subscribed to FFE4");
        log("Subscribed to notifications.");
        stopReconnect();
      } catch (err) {
        setStatus("Subscription failed: " + err.message);
        setSubscriptionStatus("Not subscribed");
        log("Failed to subscribe: " + err.message);
        console.error("Subscription error:", err);
        startReconnect();
      }
    }
    async function listServicesAndCharacteristics(server) {
      const services = await server.getPrimaryServices();
      for (const service of services) {
        log(`Service: ${service.uuid}`);
        const characteristics = await service.getCharacteristics();
        for (const char of characteristics) {
          log(`  Characteristic: ${char.uuid}, Properties: ${JSON.stringify(char.properties)}`);
        }
      }
    }

    async function connect() {
      try {
        if (bleDevice && bleDevice.gatt.connected) {
          log("Already connected.");
          setStatus("Already connected.");
          return;
        }

        setStatus("Requesting device...");
        bleDevice = await navigator.bluetooth.requestDevice({
          filters: [{ services: [serviceUUID] }],
          optionalServices: [serviceUUID]
        });

        bleDevice.addEventListener('gattserverdisconnected', () => {
          setStatus("Disconnected");
          setSubscriptionStatus("Not subscribed");
          log("Device disconnected.");
          bleDevice = null;
          startReconnect();
        });

        setStatus("Connecting...");
        const server = await bleDevice.gatt.connect();
        await subscribeToNotifications(server);

      } catch (err) {
        setStatus("Connection failed: " + err.message);
        setSubscriptionStatus("Not subscribed");
        log("Connection failed: " + err.message);
        console.error("Connection error:", err);
        bleDevice = null;
        startReconnect();
      }
    }

    function disconnect() {
      if (bleDevice && bleDevice.gatt.connected) {
        bleDevice.gatt.disconnect();
        setStatus("Disconnected by user");
        setSubscriptionStatus("Not subscribed");
        log("Disconnected from device.");
      } else {
        alert("No device is currently connected.");
      }
      bleDevice = null;
      stopReconnect();
    }

    function startReconnect() {
      if (!reconnectInterval) {
        log("Starting reconnect attempts every 5 seconds...");
        reconnectInterval = setInterval(async () => {
          if (!bleDevice) {
            log("Attempting to reconnect...");
            try {
              await connect();
            } catch (err) {
              log("Reconnect failed: " + err.message);
            }
          }
        }, 5000);
      }
    }

    function stopReconnect() {
      if (reconnectInterval) {
        clearInterval(reconnectInterval);
        reconnectInterval = null;
        log("Stopped reconnect attempts.");
      }
    }
  </script>
</body>
</html>
